#!/usr/bin/env node

/**
 * DX CLI - NestJS é¡¹ç›®ç»Ÿä¸€ç®¡ç†å·¥å…·
 *
 * ç”¨æ³•:
 *   dx startup [ç¯å¢ƒæ ‡å¿—]          - é¡¹ç›®åˆå§‹åŒ–(å®‰è£…ä¾èµ–/ç”ŸæˆClient/é‡ç½®æ•°æ®åº“)
 *   dx start [service] [ç¯å¢ƒæ ‡å¿—]  - å¯åŠ¨æœåŠ¡
 *   dx build [ç¯å¢ƒæ ‡å¿—]            - æ„å»ºåº”ç”¨
 *   dx db [action] [ç¯å¢ƒæ ‡å¿—]      - æ•°æ®åº“æ“ä½œ
 *   dx test [type]                 - è¿è¡Œæµ‹è¯•
 *   dx lint                        - ä»£ç æ£€æŸ¥
 *   dx format                      - ä»£ç æ ¼å¼åŒ–
 *   dx env [action] [ç¯å¢ƒæ ‡å¿—]     - ç¯å¢ƒç®¡ç†
 *   dx clean [target]              - æ¸…ç†æ“ä½œ
 *
 * å…¨å±€é€‰é¡¹:
 *   --dev, --development      - å¼€å‘ç¯å¢ƒ
 *   --prod, --production      - ç”Ÿäº§ç¯å¢ƒ
 *   --test                    - æµ‹è¯•ç¯å¢ƒ
 *   --e2e                     - E2Eæµ‹è¯•ç¯å¢ƒ
 *   -Y, --yes                 - è·³è¿‡ç¡®è®¤æç¤º
 *   -v, --verbose             - è¯¦ç»†è¾“å‡º
 *   -h, --help                - æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
 */

import { readFileSync } from 'fs'
import { join } from 'path'
import { fileURLToPath } from 'url'
import { dirname } from 'path'
import { logger } from './lib/logger.js'
import { envManager } from './lib/env.js'
import { execManager } from './lib/exec.js'
import { confirmManager } from './lib/confirm.js'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)

class DxCli {
  constructor() {
    this.commands = this.loadCommands()
    this.args = process.argv.slice(2)
    this.flags = this.parseFlags()
  }

  loadCommands() {
    try {
      const configPath = join(__dirname, 'config/commands.json')
      return JSON.parse(readFileSync(configPath, 'utf8'))
    } catch (error) {
      logger.error('æ— æ³•åŠ è½½å‘½ä»¤é…ç½®æ–‡ä»¶')
      logger.error(error.message)
      process.exit(1)
    }
  }

  parseFlags() {
    const flags = {}
    for (const arg of this.args) {
      if (!arg.startsWith('-')) continue

      switch (arg) {
        case '--dev':
        case '--development':
          flags.dev = true
          break
        case '--prod':
        case '--production':
          flags.prod = true
          break
        case '--test':
          flags.test = true
          break
        case '--e2e':
          flags.e2e = true
          break
        case '-Y':
        case '--yes':
          flags.Y = true
          break
        case '-v':
        case '--verbose':
          flags.verbose = true
          break
        case '-h':
        case '--help':
          flags.help = true
          break
      }
    }
    return flags
  }

  getCleanArgs() {
    return this.args.filter(arg => !arg.startsWith('-'))
  }

  async run() {
    try {
      const cleanArgs = this.getCleanArgs()

      if (this.flags.help || cleanArgs.length === 0) {
        this.showHelp()
        return
      }

      if (this.flags.verbose) {
        logger.logLevel = 'debug'
        logger.debug('å¯ç”¨è¯¦ç»†è¾“å‡ºæ¨¡å¼')
      }

      await this.routeCommand()
    } catch (error) {
      logger.error('å‘½ä»¤æ‰§è¡Œå¤±è´¥')
      logger.error(error.message)

      if (this.flags.verbose) {
        console.error(error.stack)
      }

      process.exit(1)
    }
  }

  async routeCommand() {
    const cleanArgs = this.getCleanArgs()
    const [command, ...subArgs] = cleanArgs

    switch (command) {
      case 'start':
        await this.handleStart(subArgs)
        break
      case 'build':
        await this.handleBuild(subArgs)
        break
      case 'db':
        await this.handleDatabase(subArgs)
        break
      case 'test':
        await this.handleTest(subArgs)
        break
      case 'lint':
        await this.handleLint()
        break
      case 'format':
        await this.handleFormat()
        break
      case 'env':
        await this.handleEnv(subArgs)
        break
      case 'clean':
        await this.handleClean(subArgs)
        break
      case 'startup':
        await this.handleStartup(subArgs)
        break
      default:
        logger.error(`æœªçŸ¥å‘½ä»¤: ${command}`)
        this.showHelp()
        process.exit(1)
    }
  }

  async handleStart(args) {
    const service = args[0] || 'dev'
    const environment = envManager.detectEnvironment(this.flags)

    const startConfig = this.commands.start[service]
    if (!startConfig) {
      logger.error(`æœªæ‰¾åˆ°å¯åŠ¨é…ç½®: ${service}`)
      process.exit(1)
      return
    }

    logger.step(`å¯åŠ¨ ${service} æœåŠ¡ (${environment})`)
    await this.executeCommand(startConfig)
  }

  async handleBuild(args) {
    const environment = envManager.detectEnvironment(this.flags)
    const envKey = environment === 'production' ? 'prod' : 'dev'

    const buildConfig = this.commands.build[envKey]
    if (!buildConfig) {
      logger.error(`æœªæ‰¾åˆ°æ„å»ºé…ç½®: ${envKey}`)
      process.exit(1)
      return
    }

    logger.step(`æ„å»ºåº”ç”¨ (${environment})`)
    await this.executeCommand(buildConfig)
  }

  async handleDatabase(args) {
    const action = args[0]
    if (!action) {
      logger.error('è¯·æŒ‡å®šæ•°æ®åº“æ“ä½œ: generate, migrate, reset, studio, seed')
      process.exit(1)
      return
    }

    const dbConfig = this.commands.db[action]
    if (!dbConfig) {
      logger.error(`æœªæ‰¾åˆ°æ•°æ®åº“æ“ä½œ: ${action}`)
      process.exit(1)
      return
    }

    const environment = envManager.detectEnvironment(this.flags)
    logger.step(`æ‰§è¡Œæ•°æ®åº“æ“ä½œ: ${action} (${environment})`)

    let config = dbConfig
    if (typeof config === 'object' && !config.command) {
      const envKey = environment === 'production' ? 'prod' : 'dev'
      config = config[envKey] || config.dev || config
    }

    // å±é™©æ“ä½œç¡®è®¤
    if (config.dangerous) {
      const confirmed = await confirmManager.confirmDatabaseOperation(
        action,
        envManager.getEnvironmentDescription(environment),
        this.flags.Y
      )

      if (!confirmed) {
        logger.info('æ“ä½œå·²å–æ¶ˆ')
        return
      }
    }

    await this.executeCommand(config)
  }

  async handleTest(args) {
    const type = args[0] || 'unit'
    const testConfig = this.commands.test[type]

    if (!testConfig) {
      logger.error(`æœªæ‰¾åˆ°æµ‹è¯•é…ç½®: ${type}`)
      process.exit(1)
      return
    }

    logger.step(`è¿è¡Œ ${type} æµ‹è¯•`)
    await this.executeCommand(testConfig)
  }

  async handleLint() {
    logger.step('è¿è¡Œä»£ç æ£€æŸ¥')
    await this.executeCommand(this.commands.lint)
  }

  async handleFormat() {
    logger.step('è¿è¡Œä»£ç æ ¼å¼åŒ–')
    await this.executeCommand(this.commands.format)
  }

  async handleEnv(args) {
    const action = args[0]
    if (!action) {
      logger.error('è¯·æŒ‡å®šç¯å¢ƒæ“ä½œ: setup, validate')
      process.exit(1)
      return
    }

    const envConfig = this.commands.env[action]
    if (!envConfig) {
      logger.error(`æœªæ‰¾åˆ°ç¯å¢ƒæ“ä½œ: ${action}`)
      process.exit(1)
      return
    }

    const environment = envManager.detectEnvironment(this.flags)
    logger.step(`æ‰§è¡Œç¯å¢ƒæ“ä½œ: ${action} (${environment})`)

    let config = envConfig
    if (typeof config === 'object' && !config.command) {
      const envKey = environment === 'production' ? 'prod' :
                     environment === 'test' ? 'test' :
                     environment === 'e2e' ? 'e2e' : 'dev'
      config = config[envKey] || config
    }

    await this.executeCommand(config)
  }

  async handleClean(args) {
    const target = args[0] || 'all'
    const cleanConfig = this.commands.clean[target]

    if (!cleanConfig) {
      logger.error(`æœªæ‰¾åˆ°æ¸…ç†ç›®æ ‡: ${target}`)
      process.exit(1)
      return
    }

    // å±é™©æ“ä½œç¡®è®¤
    if (cleanConfig.dangerous) {
      const confirmed = await confirmManager.confirmDangerous(
        `æ¸…ç†æ“ä½œ: ${target}`,
        'å½“å‰ç¯å¢ƒ',
        this.flags.Y
      )

      if (!confirmed) {
        logger.info('æ“ä½œå·²å–æ¶ˆ')
        return
      }
    }

    logger.step(`æ¸…ç† ${target}`)
    await this.executeCommand(cleanConfig)
  }

  async handleStartup(args) {
    const environment = envManager.detectEnvironment(this.flags)
    const envKey = 'dev' // å§‹ç»ˆä½¿ç”¨ dev é…ç½®

    const startupConfig = this.commands.startup[envKey]
    if (!startupConfig) {
      logger.error(`æœªæ‰¾åˆ°å¯åŠ¨é…ç½®: ${envKey}`)
      process.exit(1)
      return
    }

    logger.step(`é¡¹ç›®åˆå§‹åŒ– (${environment})`)

    // å±é™©æ“ä½œç¡®è®¤
    if (startupConfig.dangerous) {
      const confirmed = await confirmManager.confirmDangerous(
        'é¡¹ç›®åˆå§‹åŒ–ï¼ˆä¼šé‡ç½®æ•°æ®åº“ï¼‰',
        envManager.getEnvironmentDescription(environment),
        this.flags.Y
      )

      if (!confirmed) {
        logger.info('æ“ä½œå·²å–æ¶ˆ')
        return
      }
    }

    // æ‰§è¡Œæ­¥éª¤é…ç½®
    if (startupConfig.steps && Array.isArray(startupConfig.steps)) {
      for (let i = 0; i < startupConfig.steps.length; i++) {
        const step = startupConfig.steps[i]
        logger.step(`[${i + 1}/${startupConfig.steps.length}] ${step.name}`)
        
        try {
          await execManager.executeCommand(step.command, {
            flags: this.flags,
          })
          logger.success(`${step.name} å®Œæˆ`)
        } catch (error) {
          logger.error(`${step.name} å¤±è´¥`)
          throw error
        }
      }

      logger.success('ğŸ‰ é¡¹ç›®åˆå§‹åŒ–å®Œæˆï¼')
    } else {
      // å…¼å®¹å•ä¸ªå‘½ä»¤é…ç½®
      await this.executeCommand(startupConfig)
    }
  }

  async executeCommand(config) {
    if (!config || !config.command) {
      logger.error('æ— æ•ˆçš„å‘½ä»¤é…ç½®')
      return
    }

    const options = {
      flags: this.flags,
      ports: config.ports || [],
    }

    await execManager.executeCommand(config.command, options)
  }

  showHelp() {
    console.log(`
DX CLI - NestJS é¡¹ç›®ç»Ÿä¸€ç®¡ç†å·¥å…·

ç”¨æ³•:
  dx <å‘½ä»¤> [é€‰é¡¹] [å‚æ•°...]

å‘½ä»¤:
  startup                   é¡¹ç›®åˆå§‹åŒ–
                            è‡ªåŠ¨æ‰§è¡Œ: å®‰è£…ä¾èµ– -> ç”Ÿæˆ Prisma Client -> é‡ç½®æ•°æ®åº“

  start [service]           å¯åŠ¨æœåŠ¡
    service: dev, debug, prod (é»˜è®¤: dev)

  build                     æ„å»ºåº”ç”¨

  db [action]               æ•°æ®åº“æ“ä½œ
    action: generate, migrate, reset, studio, seed

  test [type]               è¿è¡Œæµ‹è¯•
    type: unit, watch, cov, e2e (é»˜è®¤: unit)

  lint                      ä»£ç æ£€æŸ¥
  format                    ä»£ç æ ¼å¼åŒ–

  env [action]              ç¯å¢ƒç®¡ç†
    action: setup, validate

  clean [target]            æ¸…ç†æ“ä½œ
    target: all, dist, deps (é»˜è®¤: all)

å…¨å±€é€‰é¡¹:
  --dev, --development      å¼€å‘ç¯å¢ƒ
  --prod, --production      ç”Ÿäº§ç¯å¢ƒ
  --test                    æµ‹è¯•ç¯å¢ƒ
  --e2e                     E2Eæµ‹è¯•ç¯å¢ƒ
  -Y, --yes                 è·³è¿‡æ‰€æœ‰ç¡®è®¤æç¤º
  -v, --verbose             è¯¦ç»†è¾“å‡º
  -h, --help                æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯

ç¤ºä¾‹:
  dx startup --dev          åˆå§‹åŒ–é¡¹ç›®(é¦–æ¬¡è¿è¡Œæ¨è)
  dx startup --dev -Y       åˆå§‹åŒ–é¡¹ç›®(è·³è¿‡ç¡®è®¤)
  dx start dev              å¯åŠ¨å¼€å‘æœåŠ¡å™¨
  dx build --prod           æ„å»ºç”Ÿäº§ç‰ˆæœ¬
  dx db migrate --dev       æ‰§è¡Œå¼€å‘ç¯å¢ƒæ•°æ®åº“è¿ç§»
  dx db reset --dev -Y      é‡ç½®å¼€å‘æ•°æ®åº“(è·³è¿‡ç¡®è®¤)
  dx test e2e               è¿è¡Œ E2E æµ‹è¯•
  dx clean deps             é‡æ–°å®‰è£…ä¾èµ–
  dx env setup --dev        è®¾ç½®å¼€å‘ç¯å¢ƒ
  dx env validate           éªŒè¯ç¯å¢ƒå˜é‡

ç¯å¢ƒè¯´æ˜:
  - ä½¿ç”¨ç¯å¢ƒæ ‡å¿—(--dev/--prod/--test/--e2e)æ˜¾å¼æŒ‡å®šç¯å¢ƒ
  - æœªæŒ‡å®šæ—¶é»˜è®¤ä½¿ç”¨å¼€å‘ç¯å¢ƒ
  - ç”Ÿäº§ç¯å¢ƒæ“ä½œä¼šè¦æ±‚é¢å¤–ç¡®è®¤
  - å¯é€šè¿‡ -Y æ ‡å¿—æˆ–ç¯å¢ƒå˜é‡ CI=true è·³è¿‡ç¡®è®¤

`)
  }
}

// åˆ›å»ºå¹¶è¿è¡Œ CLI
const cli = new DxCli()
cli.run().catch(error => {
  logger.error('CLIå¯åŠ¨å¤±è´¥')
  logger.error(error.message)
  process.exit(1)
})
