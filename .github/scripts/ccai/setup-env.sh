#!/bin/bash
# ==========================================
# ç¯å¢ƒé…ç½®æ–‡ä»¶ç”Ÿæˆè„šæœ¬
# åŠŸèƒ½: åˆ›å»º .env.development.local
# è¾“å…¥: $1 = ANTHROPIC_API_KEY, $2 = ANTHROPIC_BASE_URL (optional), $3 = PAT_TOKEN (optional)
# è¾“å‡º: .env.development.local æ–‡ä»¶
# ==========================================

set -euo pipefail

ANTHROPIC_API_KEY="$1"
ANTHROPIC_BASE_URL="${2:-}"
PAT_TOKEN="${3:-}"

# éªŒè¯å‚æ•°
if [ -z "$ANTHROPIC_API_KEY" ]; then
  echo "âŒ Error: ANTHROPIC_API_KEY is required"
  exit 1
fi

echo "ğŸ“ Creating environment configuration file..."

# åˆ›å»ºç¯å¢ƒæ–‡ä»¶
cat > .env.development.local << EOF
# ==========================================
# CI Environment Configuration
# Auto-generated by GitHub Actions
# ==========================================

# Application
NODE_ENV=development
PORT=3000

# Database (Service Container)
DATABASE_URL="postgresql://test_user:test_password@localhost:5432/nestjs_ci_test?schema=public"

# Redis (Service Container)
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0

# Logging
LOG_LEVEL=debug

# Anthropic API Configuration (from GitHub Secrets)
ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
EOF

# å¦‚æœæä¾›äº† ANTHROPIC_BASE_URLï¼Œåˆ™æ·»åŠ åˆ°é…ç½®æ–‡ä»¶
if [ -n "$ANTHROPIC_BASE_URL" ]; then
  echo "ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL}" >> .env.development.local
fi

# å¦‚æœæä¾›äº† PAT_TOKENï¼Œåˆ™æ·»åŠ  GITHUB_TOKEN åˆ°é…ç½®æ–‡ä»¶ï¼ˆä¾› Claude Code agent ä½¿ç”¨ï¼‰
if [ -n "$PAT_TOKEN" ]; then
  echo "GITHUB_TOKEN=${PAT_TOKEN}" >> .env.development.local
fi

echo "âœ… Environment file created: .env.development.local"

# æ˜¾ç¤ºå†…å®¹ (éšè—æ•æ„Ÿä¿¡æ¯)
echo "ğŸ“„ File contents (sensitive info hidden):"
cat .env.development.local | grep -v "ANTHROPIC_API_KEY" | grep -v "ANTHROPIC_BASE_URL" | grep -v "GITHUB_TOKEN"
echo "ANTHROPIC_API_KEY=***REDACTED***"
if [ -n "$ANTHROPIC_BASE_URL" ]; then
  echo "ANTHROPIC_BASE_URL=***REDACTED***"
fi
if [ -n "$PAT_TOKEN" ]; then
  echo "GITHUB_TOKEN=***REDACTED***"
fi
