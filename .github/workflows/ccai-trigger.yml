name: CCAI Trigger - Issue/PR Comment Listener

# è§¦å‘äº‹ä»¶: Issue è¯„è®ºå’Œ PR Review è¯„è®º
on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

# æƒé™é…ç½®
permissions:
  contents: write       # å…è®¸æ¨é€ä»£ç 
  pull-requests: write  # å…è®¸åˆ›å»ºå’Œæ›´æ–° PR
  issues: write         # å…è®¸åˆ›å»ºå’Œæ›´æ–°è¯„è®º

jobs:
  # ==========================================
  # Job 1: éªŒè¯å’Œå‚æ•°æå–
  # ==========================================
  validate-and-extract:
    name: Validate & Extract Parameters
    runs-on: ubuntu-latest

    # ä»…åœ¨è¯„è®ºä»¥ @ccai å¼€å¤´æ—¶è§¦å‘
    if: startsWith(github.event.comment.body, '@ccai')

    outputs:
      should_proceed: ${{ steps.validate.outputs.should_proceed }}
      issue_number: ${{ steps.extract-issue.outputs.issue_number }}
      prompt: ${{ steps.extract-prompt.outputs.prompt }}
      comment_id: ${{ steps.initial-comment.outputs.comment_id }}

    steps:
      # ------------------------------------------
      # æ­¥éª¤ 1: æƒé™éªŒè¯
      # ------------------------------------------
      - name: Check user permission
        id: check-permission
        uses: actions/github-script@v7
        with:
          script: |
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.actor
            });

            const hasPermission = ['admin', 'write'].includes(permission.permission);

            if (!hasPermission) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'âŒ æƒé™ä¸è¶³: åªæœ‰æ‹¥æœ‰ write æˆ– admin æƒé™çš„ç”¨æˆ·æ‰èƒ½è§¦å‘ Claude Codeã€‚'
              });
              core.setFailed('User does not have sufficient permissions');
            }

            core.setOutput('has_permission', hasPermission);
            return hasPermission;

      # ------------------------------------------
      # æ­¥éª¤ 2: æå– Issue ID
      # ------------------------------------------
      - name: Extract Issue ID
        id: extract-issue
        if: steps.check-permission.outputs.has_permission == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            let issueNumber = null;

            // åœºæ™¯ 1: Issue è¯„è®º
            if (context.eventName === 'issue_comment') {
              issueNumber = context.issue.number;
              console.log(`Issue comment detected: #${issueNumber}`);
            }
            // åœºæ™¯ 2: PR Review è¯„è®º
            else if (context.eventName === 'pull_request_review_comment') {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number
              });

              const body = pr.body || '';
              const issueMatch = body.match(/(?:Closes|Fixes|Resolves)\s+#(\d+)/i);

              if (issueMatch) {
                issueNumber = parseInt(issueMatch[1], 10);
                console.log(`PR comment detected, extracted issue: #${issueNumber}`);
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: 'âŒ æ— æ³•ä» PR æè¿°ä¸­æå– Issue ç¼–å·ã€‚è¯·åœ¨ PR æè¿°ä¸­æ·»åŠ  "Closes #xxx" æˆ– "Fixes #xxx"ã€‚'
                });
                core.setFailed('Unable to extract issue number from PR');
                return null;
              }
            }

            if (!issueNumber) {
              core.setFailed('Failed to determine issue number');
            }

            core.setOutput('issue_number', issueNumber);
            return issueNumber;

      # ------------------------------------------
      # æ­¥éª¤ 3: æå–æç¤ºè¯
      # ------------------------------------------
      - name: Extract prompt
        id: extract-prompt
        if: steps.extract-issue.outputs.issue_number
        uses: actions/github-script@v7
        with:
          script: |
            const commentBody = context.payload.comment.body;
            const prompt = commentBody.replace(/^@ccai\s+/, '').trim();

            if (!prompt) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'âŒ è¯·æä¾›å…·ä½“çš„ä»»åŠ¡æè¿°ã€‚æ ¼å¼: `@ccai <your task description>`'
              });
              core.setFailed('Empty prompt');
              return null;
            }

            core.setOutput('prompt', prompt);
            console.log(`Extracted prompt: ${prompt}`);
            return prompt;

      # ------------------------------------------
      # æ­¥éª¤ 4: åˆ›å»ºåˆå§‹åé¦ˆè¯„è®º
      # ------------------------------------------
      - name: Post initial comment
        id: initial-comment
        if: steps.extract-prompt.outputs.prompt
        uses: actions/github-script@v7
        with:
          script: |
            const prompt = `${{ steps.extract-prompt.outputs.prompt }}`;
            const { data: comment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸ¤– Claude Code æ­£åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚...\n\nğŸ“‹ **ä»»åŠ¡**: ${prompt}\n\nâ³ è¯·ç¨å€™...`
            });

            core.setOutput('comment_id', comment.id);
            return comment.id;

      # ------------------------------------------
      # æ­¥éª¤ 5: è®¾ç½®éªŒè¯æ ‡å¿—
      # ------------------------------------------
      - name: Set validation result
        id: validate
        if: always()
        run: |
          if [ "${{ steps.check-permission.outputs.has_permission }}" == "true" ] && \
             [ -n "${{ steps.extract-issue.outputs.issue_number }}" ] && \
             [ -n "${{ steps.extract-prompt.outputs.prompt }}" ]; then
            echo "should_proceed=true" >> $GITHUB_OUTPUT
          else
            echo "should_proceed=false" >> $GITHUB_OUTPUT
          fi

  # ==========================================
  # Job 2: è°ƒç”¨æ‰§è¡Œå·¥ä½œæµ
  # ==========================================
  execute-task:
    name: Execute Claude Code Task
    needs: validate-and-extract
    if: needs.validate-and-extract.outputs.should_proceed == 'true'
    uses: ./.github/workflows/ccai-execute.yml
    with:
      issue_number: ${{ needs.validate-and-extract.outputs.issue_number }}
      prompt: ${{ needs.validate-and-extract.outputs.prompt }}
      comment_id: ${{ needs.validate-and-extract.outputs.comment_id }}
    secrets:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
