name: CCAI Trigger - Issue Comment Listener

# è§¦å‘äº‹ä»¶: ä»… Issue è¯„è®ºï¼ˆä¸åŒ…æ‹¬ PR è¯„è®ºï¼Œé¿å…é‡å¤è§¦å‘ï¼‰
on:
  issue_comment:
    types: [created]

# æƒé™é…ç½®
permissions:
  contents: write       # å…è®¸æ¨é€ä»£ç 
  pull-requests: write  # å…è®¸åˆ›å»ºå’Œæ›´æ–° PR
  issues: write         # å…è®¸åˆ›å»ºå’Œæ›´æ–°è¯„è®º

jobs:
  # ==========================================
  # Job 1: éªŒè¯å’Œå‚æ•°æå–
  # ==========================================
  validate-and-extract:
    name: Validate & Extract Parameters
    runs-on: ubuntu-latest

    # ä»…åœ¨è¯„è®ºåŒ…å« @ccai æ—¶è§¦å‘ï¼ˆé€šè¿‡ JavaScript å®ç°å¤§å°å†™ä¸æ•æ„Ÿæ£€æŸ¥ï¼‰
    if: github.event.comment.body != ''

    outputs:
      should_proceed: ${{ steps.validate.outputs.should_proceed }}
      issue_number: ${{ steps.extract-issue.outputs.issue_number }}
      prompt: ${{ steps.extract-prompt.outputs.prompt }}
      comment_id: ${{ steps.initial-comment.outputs.comment_id }}

    steps:
      # ------------------------------------------
      # æ­¥éª¤ 1: æ£€æŸ¥è§¦å‘è¯ï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰å’Œä¸Šä¸‹æ–‡
      # ------------------------------------------
      - name: Check trigger word and context
        id: check-trigger
        uses: actions/github-script@v7
        with:
          script: |
            const commentBody = context.payload.comment.body;
            
            // å¤§å°å†™ä¸æ•æ„Ÿæ£€æŸ¥æ˜¯å¦ä»¥ @ccai å¼€å¤´
            const hasTrigger = /^@ccai\s+/i.test(commentBody);

            if (!hasTrigger) {
              console.log('Comment does not start with @ccai (case-insensitive), skipping...');
              return false;
            }

            // å¦‚æœæ˜¯ issue_comment äº‹ä»¶ï¼Œæ£€æŸ¥æ˜¯å¦åœ¨ PR ä¸­
            if (context.eventName === 'issue_comment' && context.payload.issue.pull_request) {
              console.log('Comment is on a PR, skipping to avoid duplicate execution.');
              console.log('Please comment on the original Issue instead.');
              
              // å¯é€‰ï¼šåœ¨ PR ä¸­å›å¤æç¤º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'âš ï¸ è¯·åœ¨åŸå§‹ Issue ä¸­ä½¿ç”¨ @ccai å‘½ä»¤ï¼Œè€Œä¸æ˜¯åœ¨ PR ä¸­ã€‚'
              });
              
              return false;
            }

            core.setOutput('has_trigger', hasTrigger);
            return hasTrigger;

      # ------------------------------------------
      # æ­¥éª¤ 2: æƒé™éªŒè¯
      # ------------------------------------------
      - name: Check user permission
        id: check-permission
        if: steps.check-trigger.outputs.has_trigger == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.actor
            });

            const hasPermission = ['admin', 'write'].includes(permission.permission);

            if (!hasPermission) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'âŒ æƒé™ä¸è¶³: åªæœ‰æ‹¥æœ‰ write æˆ– admin æƒé™çš„ç”¨æˆ·æ‰èƒ½è§¦å‘ Claude Codeã€‚'
              });
              core.setFailed('User does not have sufficient permissions');
            }

            core.setOutput('has_permission', hasPermission);
            return hasPermission;

      # ------------------------------------------
      # æ­¥éª¤ 3: æå– Issue ID
      # ------------------------------------------
      - name: Extract Issue ID
        id: extract-issue
        if: steps.check-trigger.outputs.has_trigger == 'true' && steps.check-permission.outputs.has_permission == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // ç”±äºæˆ‘ä»¬å·²ç»åœ¨æ­¥éª¤ 1 ä¸­è¿‡æ»¤æ‰äº† PR è¯„è®ºï¼Œè¿™é‡Œç›´æ¥è·å– Issue ç¼–å·
            const issueNumber = context.issue.number;
            console.log(`Issue comment detected: #${issueNumber}`);

            if (!issueNumber) {
              core.setFailed('Failed to determine issue number');
              return null;
            }

            core.setOutput('issue_number', issueNumber);
            return issueNumber;

      # ------------------------------------------
      # æ­¥éª¤ 4: æå–æç¤ºè¯
      # ------------------------------------------
      - name: Extract prompt
        id: extract-prompt
        if: steps.extract-issue.outputs.issue_number
        uses: actions/github-script@v7
        with:
          script: |
            const commentBody = context.payload.comment.body;
            // å¤§å°å†™ä¸æ•æ„Ÿåœ°ç§»é™¤ @ccai å‰ç¼€
            const prompt = commentBody.replace(/^@ccai\s+/i, '').trim();

            if (!prompt) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'âŒ è¯·æä¾›å…·ä½“çš„ä»»åŠ¡æè¿°ã€‚æ ¼å¼: `@ccai <your task description>`'
              });
              core.setFailed('Empty prompt');
              return null;
            }

            core.setOutput('prompt', prompt);
            console.log(`Extracted prompt: ${prompt}`);
            return prompt;

      # ------------------------------------------
      # æ­¥éª¤ 5: åˆ›å»ºåˆå§‹åé¦ˆè¯„è®º
      # ------------------------------------------
      - name: Post initial comment
        id: initial-comment
        if: steps.extract-prompt.outputs.prompt
        uses: actions/github-script@v7
        with:
          script: |
            const prompt = `${{ steps.extract-prompt.outputs.prompt }}`;
            const { data: comment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸ¤– Claude Code æ­£åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚...\n\nğŸ“‹ **ä»»åŠ¡**: ${prompt}\n\nâ³ è¯·ç¨å€™...`
            });

            core.setOutput('comment_id', comment.id);
            return comment.id;

      # ------------------------------------------
      # æ­¥éª¤ 6: è®¾ç½®éªŒè¯æ ‡å¿—
      # ------------------------------------------
      - name: Set validation result
        id: validate
        if: always()
        run: |
          if [ "${{ steps.check-trigger.outputs.has_trigger }}" == "true" ] && \
             [ "${{ steps.check-permission.outputs.has_permission }}" == "true" ] && \
             [ -n "${{ steps.extract-issue.outputs.issue_number }}" ] && \
             [ -n "${{ steps.extract-prompt.outputs.prompt }}" ]; then
            echo "should_proceed=true" >> $GITHUB_OUTPUT
          else
            echo "should_proceed=false" >> $GITHUB_OUTPUT
          fi

  # ==========================================
  # Job 2: è°ƒç”¨æ‰§è¡Œå·¥ä½œæµ
  # ==========================================
  execute-task:
    name: Execute Claude Code Task
    needs: validate-and-extract
    if: needs.validate-and-extract.outputs.should_proceed == 'true'
    uses: ./.github/workflows/ccai-execute.yml
    with:
      issue_number: ${{ needs.validate-and-extract.outputs.issue_number }}
      prompt: ${{ needs.validate-and-extract.outputs.prompt }}
      comment_id: ${{ needs.validate-and-extract.outputs.comment_id }}
    secrets:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
