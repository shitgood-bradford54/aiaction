name: Claude Code AI Assistant

# è§¦å‘å™¨: Issue è¯„è®ºå’Œ PR Review è¯„è®º
on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

# æƒé™é…ç½®
permissions:
  contents: write       # å…è®¸æ¨é€ä»£ç 
  pull-requests: write  # å…è®¸åˆ›å»ºå’Œæ›´æ–° PR
  issues: write         # å…è®¸åˆ›å»ºå’Œæ›´æ–°è¯„è®º

jobs:
  ccai-task:
    # ä»…åœ¨è¯„è®ºä»¥ @ccai å¼€å¤´æ—¶è§¦å‘
    if: startsWith(github.event.comment.body, '@ccai')

    runs-on: ubuntu-latest
    timeout-minutes: 60  # å·¥ä½œæµæœ€å¤§æ‰§è¡Œæ—¶é—´

    # å¹¶å‘æ§åˆ¶: æŒ‰ issue ID æ’é˜Ÿ,ä¸å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡
    concurrency:
      group: ccai-issue-${{ github.event.issue.number || github.event.pull_request.number }}
      cancel-in-progress: false

    # Service Containers: PostgreSQL + Redis
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: nestjs_ci_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U test_user"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      # ==========================================
      # æ­¥éª¤ 1: æƒé™éªŒè¯
      # ==========================================
      - name: Check user permission
        id: check-permission
        uses: actions/github-script@v7
        with:
          script: |
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.actor
            });

            const hasPermission = ['admin', 'write'].includes(permission.permission);

            if (!hasPermission) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'âŒ æƒé™ä¸è¶³: åªæœ‰æ‹¥æœ‰ write æˆ– admin æƒé™çš„ç”¨æˆ·æ‰èƒ½è§¦å‘ Claude Codeã€‚'
              });
              core.setFailed('User does not have sufficient permissions');
            }

            return hasPermission;

      # ==========================================
      # æ­¥éª¤ 2: æå– Issue ID
      # ==========================================
      - name: Extract Issue ID
        id: extract-issue
        uses: actions/github-script@v7
        with:
          script: |
            let issueNumber = null;

            // åœºæ™¯ 1: Issue è¯„è®º
            if (context.eventName === 'issue_comment') {
              issueNumber = context.issue.number;
              console.log(`Issue comment detected: #${issueNumber}`);
            }
            // åœºæ™¯ 2: PR è¯„è®º
            else if (context.eventName === 'pull_request_review_comment') {
              // è·å– PR è¯¦æƒ…
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number
              });

              // ä» PR body ä¸­æå– issue ç¼–å·
              const body = pr.body || '';
              const issueMatch = body.match(/(?:Closes|Fixes|Resolves)\s+#(\d+)/i);

              if (issueMatch) {
                issueNumber = parseInt(issueMatch[1], 10);
                console.log(`PR comment detected, extracted issue: #${issueNumber}`);
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: 'âŒ æ— æ³•ä» PR æè¿°ä¸­æå– Issue ç¼–å·ã€‚è¯·åœ¨ PR æè¿°ä¸­æ·»åŠ  "Closes #xxx" æˆ– "Fixes #xxx"ã€‚'
                });
                core.setFailed('Unable to extract issue number from PR');
                return null;
              }
            }

            if (!issueNumber) {
              core.setFailed('Failed to determine issue number');
            }

            core.setOutput('issue_number', issueNumber);
            return issueNumber;

      # ==========================================
      # æ­¥éª¤ 3: æå–ç”¨æˆ·æç¤ºè¯
      # ==========================================
      - name: Extract prompt
        id: extract-prompt
        uses: actions/github-script@v7
        with:
          script: |
            const commentBody = context.payload.comment.body;
            const prompt = commentBody.replace(/^@ccai\s+/, '').trim();

            if (!prompt) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'âŒ è¯·æä¾›å…·ä½“çš„ä»»åŠ¡æè¿°ã€‚æ ¼å¼: `@ccai <your task description>`'
              });
              core.setFailed('Empty prompt');
              return null;
            }

            core.setOutput('prompt', prompt);
            console.log(`Extracted prompt: ${prompt}`);
            return prompt;

      # ==========================================
      # æ­¥éª¤ 4: åˆ›å»ºåˆå§‹åé¦ˆè¯„è®º
      # ==========================================
      - name: Post initial comment
        id: initial-comment
        uses: actions/github-script@v7
        with:
          script: |
            const prompt = `${{ steps.extract-prompt.outputs.prompt }}`;
            const { data: comment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸ¤– Claude Code æ­£åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚...\n\nğŸ“‹ **ä»»åŠ¡**: ${prompt}\n\nâ³ è¯·ç¨å€™...`
            });

            core.setOutput('comment_id', comment.id);
            return comment.id;

      # ==========================================
      # æ­¥éª¤ 5: æ£€å‡ºä»£ç 
      # ==========================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥æ”¯æŒåˆ†æ”¯æ“ä½œ
          token: ${{ secrets.GITHUB_TOKEN }}

      # ==========================================
      # æ­¥éª¤ 6: åˆ†æ”¯ç®¡ç†
      # ==========================================
      - name: Setup branch
        id: setup-branch
        run: |
          ISSUE_NUMBER="${{ steps.extract-issue.outputs.issue_number }}"
          BRANCH_NAME="issue_${ISSUE_NUMBER}"

          # é…ç½® Git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # æ£€æŸ¥åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch $BRANCH_NAME exists, checking out and pulling..."
            git fetch origin "$BRANCH_NAME"
            git checkout "$BRANCH_NAME"
            git pull origin "$BRANCH_NAME"
          else
            echo "Branch $BRANCH_NAME does not exist, creating from main..."
            git checkout -b "$BRANCH_NAME" main
          fi

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "âœ… Branch setup complete: $BRANCH_NAME"

      # ==========================================
      # æ­¥éª¤ 7: è®¾ç½® Node.js
      # ==========================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # ==========================================
      # æ­¥éª¤ 8: å®‰è£…ä¾èµ–
      # ==========================================
      - name: Install dependencies
        run: |
          npm ci --prefer-offline --no-audit

      # ==========================================
      # æ­¥éª¤ 9: åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶
      # ==========================================
      - name: Create environment file
        run: |
          cat > .env.development.local << 'EOF'
          # CI Environment Configuration
          NODE_ENV=development
          PORT=3000

          # Database (Service Container)
          DATABASE_URL="postgresql://test_user:test_password@localhost:5432/nestjs_ci_test?schema=public"

          # Redis (Service Container)
          REDIS_HOST=localhost
          REDIS_PORT=6379
          REDIS_PASSWORD=
          REDIS_DB=0

          # Logging
          LOG_LEVEL=debug

          # Anthropic API Configuration
          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL=${{ secrets.ANTHROPIC_BASE_URL }}
          EOF

          echo "âœ… Environment file created"
          cat .env.development.local | grep -v "ANTHROPIC_API_KEY"

      # ==========================================
      # æ­¥éª¤ 10: å®‰è£… Claude Code CLI
      # ==========================================
      - name: Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code
          claude --version

      # ==========================================
      # æ­¥éª¤ 11: æ‰§è¡Œ Claude Code ä»»åŠ¡
      # ==========================================
      - name: Run Claude Code
        id: run-claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        run: |
          set +e  # å…è®¸å‘½ä»¤å¤±è´¥,ä»¥ä¾¿æ•è·é€€å‡ºç 

          PROMPT="${{ steps.extract-prompt.outputs.prompt }}"

          # æ‰§è¡Œ Claude Code (éäº¤äº’æ¨¡å¼)
          claude -p "$PROMPT" 2>&1 | tee claude_output.log
          CLAUDE_EXIT_CODE=$?

          echo "exit_code=$CLAUDE_EXIT_CODE" >> $GITHUB_OUTPUT

          # æ£€æŸ¥æ˜¯å¦æœ‰äº¤äº’è¯·æ±‚
          if grep -q "éœ€è¦æ›´å¤šä¿¡æ¯\|è¯·ç¡®è®¤\|human interaction" claude_output.log; then
            echo "interaction_detected=true" >> $GITHUB_OUTPUT
            # æå–äº¤äº’å†…å®¹ (å‰20è¡Œ)
            INTERACTION_MESSAGE=$(grep -A 5 "éœ€è¦æ›´å¤šä¿¡æ¯\|è¯·ç¡®è®¤\|human interaction" claude_output.log | head -20)
            echo "interaction_message<<EOF" >> $GITHUB_OUTPUT
            echo "$INTERACTION_MESSAGE" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "interaction_detected=false" >> $GITHUB_OUTPUT
          fi

          exit $CLAUDE_EXIT_CODE

      # ==========================================
      # æ­¥éª¤ 12: å¤„ç† Claude äº¤äº’è¯·æ±‚
      # ==========================================
      - name: Handle Claude interaction
        if: steps.run-claude.outputs.interaction_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.initial-comment.outputs.comment_id }};
            const interactionMessage = `${{ steps.run-claude.outputs.interaction_message }}`;

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: `ğŸ¤– Claude Code éœ€è¦æ›´å¤šä¿¡æ¯:\n\n\`\`\`\n${interactionMessage}\n\`\`\`\n\nè¯·åœ¨æ­¤è¯„è®ºä¸‹å›å¤,ç„¶åé‡æ–°è§¦å‘å·¥ä½œæµã€‚`
            });

      # ==========================================
      # æ­¥éª¤ 13: æ£€æŸ¥ Git å˜æ›´
      # ==========================================
      - name: Check for changes
        id: check-changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Detected code changes"
            git status --short
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No code changes detected"
          fi

      # ==========================================
      # æ­¥éª¤ 14: æ¨é€å˜æ›´
      # ==========================================
      - name: Push changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          BRANCH_NAME="${{ steps.setup-branch.outputs.branch_name }}"
          ISSUE_NUMBER="${{ steps.extract-issue.outputs.issue_number }}"

          git add .
          git commit -m "chore: Claude Code automated changes for issue #${ISSUE_NUMBER}

          Co-Authored-By: Claude <noreply@anthropic.com>" || true
          git push origin "$BRANCH_NAME"

          echo "âœ… Changes pushed to branch: $BRANCH_NAME"

      # ==========================================
      # æ­¥éª¤ 15: åˆ›å»º Pull Request
      # ==========================================
      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true' && steps.run-claude.outputs.exit_code == '0'
        id: create-pr
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ steps.setup-branch.outputs.branch_name }}';
            const issueNumber = ${{ steps.extract-issue.outputs.issue_number }};
            const prompt = `${{ steps.extract-prompt.outputs.prompt }}`;

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ PR
            const { data: existingPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branchName}`,
              state: 'open'
            });

            let prUrl;

            if (existingPRs.length > 0) {
              prUrl = existingPRs[0].html_url;
              console.log(`PR already exists: ${prUrl}`);
            } else {
              // åˆ›å»ºæ–° PR
              const { data: pr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Fix: Issue #${issueNumber} - Claude Code automated changes`,
                head: branchName,
                base: 'main',
                body: `Closes #${issueNumber}

            ğŸ¤– This PR was automatically generated by Claude Code.

            **Original Request**: ${prompt}

            ---
            Generated with [Claude Code](https://claude.com/claude-code)`
              });

              prUrl = pr.html_url;
              console.log(`Created new PR: ${prUrl}`);
            }

            core.setOutput('pr_url', prUrl);
            return prUrl;

      # ==========================================
      # æ­¥éª¤ 16: æ›´æ–°æˆåŠŸè¯„è®º
      # ==========================================
      - name: Update comment on success
        if: success() && steps.create-pr.outputs.pr_url
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.initial-comment.outputs.comment_id }};
            const prUrl = '${{ steps.create-pr.outputs.pr_url }}';
            const prompt = `${{ steps.extract-prompt.outputs.prompt }}`;

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: `âœ… **ä»»åŠ¡å®Œæˆ!**

ğŸ“‹ **åŸå§‹è¯·æ±‚**: ${prompt}

ğŸ”— **Pull Request**: ${prUrl}

è¯·æŸ¥çœ‹ PR å¹¶è¿›è¡Œä»£ç å®¡æŸ¥ã€‚`
            });

      # ==========================================
      # æ­¥éª¤ 17: æ›´æ–°å¤±è´¥è¯„è®º
      # ==========================================
      - name: Update comment on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.initial-comment.outputs.comment_id }};
            const prompt = `${{ steps.extract-prompt.outputs.prompt }}`;
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: `âŒ **ä»»åŠ¡å¤±è´¥**

ğŸ“‹ **åŸå§‹è¯·æ±‚**: ${prompt}

ğŸ” **æŸ¥çœ‹è¯¦ç»†æ—¥å¿—**: [GitHub Actions è¿è¡Œè®°å½•](${runUrl})

è¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯å¹¶é‡è¯•ã€‚`
            });

      # ==========================================
      # æ­¥éª¤ 18: æ›´æ–°æ— å˜æ›´è¯„è®º
      # ==========================================
      - name: Update comment on no changes
        if: success() && steps.check-changes.outputs.has_changes == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ steps.initial-comment.outputs.comment_id }};
            const prompt = `${{ steps.extract-prompt.outputs.prompt }}`;

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: `âš ï¸ **ä»»åŠ¡å®Œæˆ,ä½†æœªæ£€æµ‹åˆ°ä»£ç å˜æ›´**

ğŸ“‹ **åŸå§‹è¯·æ±‚**: ${prompt}

Claude Code æ‰§è¡Œå®Œæˆ,ä½†æœªç”Ÿæˆä»»ä½•ä»£ç å˜æ›´ã€‚è¯·æ£€æŸ¥ä»»åŠ¡æ˜¯å¦éœ€è¦ä»£ç ä¿®æ”¹ã€‚`
            });
