name: CCAI Execute - Reusable Workflow

# å¯å¤ç”¨å·¥ä½œæµ: è¢« ccai-trigger.yml è°ƒç”¨
on:
  workflow_call:
    inputs:
      issue_number:
        description: 'Issue number'
        required: true
        type: string
      prompt:
        description: 'User prompt for Claude Code'
        required: true
        type: string
      comment_id:
        description: 'Initial comment ID for updates'
        required: true
        type: string
    secrets:
      ANTHROPIC_API_KEY:
        description: 'Anthropic API Key for Claude Code'
        required: true
      ANTHROPIC_BASE_URL:
        description: 'Anthropic API Base URL (optional, for third-party proxies)'
        required: false
      PAT_TOKEN:
        description: 'Personal Access Token with pull_requests:write permission'
        required: false

jobs:
  execute:
    name: Execute Claude Code
    runs-on: ubuntu-latest
    timeout-minutes: 60

    # å¹¶å‘æ§åˆ¶: æŒ‰ issue ID æ’é˜Ÿ
    concurrency:
      group: ccai-issue-${{ inputs.issue_number }}
      cancel-in-progress: false

    # Service Containers: PostgreSQL + Redis
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: nestjs_ci_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U test_user"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      # ==========================================
      # æ­¥éª¤ 0: æ£€æµ‹æ’é˜ŸçŠ¶æ€å¹¶é€šçŸ¥ç”¨æˆ·
      # ==========================================
      - name: Check if queued and notify
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = ${{ inputs.comment_id }};
            const prompt = `${{ inputs.prompt }}`;
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            // æ£€æŸ¥æ˜¯å¦æœ‰åŒä¸€ issue çš„å…¶ä»–è¿è¡Œä¸­çš„ä»»åŠ¡
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ccai-execute.yml',
              status: 'in_progress'
            });

            // è¿‡æ»¤å‡ºåŒä¸€ issue çš„å…¶ä»–è¿è¡Œ
            const sameIssueRuns = runs.workflow_runs.filter(run =>
              run.id !== context.runId &&
              run.name.includes('issue_${{ inputs.issue_number }}')
            );

            if (sameIssueRuns.length > 0) {
              // æœ‰å…¶ä»–ä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œæ›´æ–°è¯„è®ºä¸º"æ’é˜Ÿä¸­"
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: commentId,
                body: 'ğŸ”„ **æ‚¨çš„è¯·æ±‚å·²åŠ å…¥é˜Ÿåˆ—**\n\n' +
                      'å‰é¢æœ‰ ' + sameIssueRuns.length + ' ä¸ªä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œè¯·ç¨å€™...\n\n' +
                      'ğŸ“ **ä»»åŠ¡**: ' + prompt + '\n' +
                      'ğŸ”— **æŸ¥çœ‹é˜Ÿåˆ—**: [Actions è¿è¡Œæ—¥å¿—](' + runUrl + ')'
              });
            }

      # ==========================================
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      # ==========================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # ==========================================
      # æ­¥éª¤ 2: åˆ†æ”¯ç®¡ç†
      # ==========================================
      - name: Setup branch
        id: setup-branch
        run: |
          bash .github/scripts/ccai/setup-branch.sh "${{ inputs.issue_number }}"

      # ==========================================
      # æ­¥éª¤ 3: è®¾ç½® Node.js
      # ==========================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # ==========================================
      # æ­¥éª¤ 4: å®‰è£…ä¾èµ–
      # ==========================================
      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      # ==========================================
      # æ­¥éª¤ 5: åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶
      # ==========================================
      - name: Create environment file
        run: |
          bash .github/scripts/ccai/setup-env.sh "${{ secrets.ANTHROPIC_API_KEY }}" "${{ secrets.ANTHROPIC_BASE_URL }}"

      # ==========================================
      # æ­¥éª¤ 6: å®‰è£… Claude Code CLI
      # ==========================================
      - name: Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code
          claude --version

      # ==========================================
      # æ­¥éª¤ 7: æ‰§è¡Œ Claude Code ä»»åŠ¡
      # ==========================================
      - name: Run Claude Code
        id: run-claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        run: |
          bash .github/scripts/ccai/run-claude.sh "${{ inputs.prompt }}"

      # ==========================================
      # æ­¥éª¤ 8: åé¦ˆ Claude è¾“å‡ºåˆ° Issue
      # ==========================================
      - name: Post Claude output to Issue
        if: always() && steps.run-claude.outcome != 'skipped'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = ${{ inputs.issue_number }};
            const claudeOutput = `${{ steps.run-claude.outputs.claude_output }}`;
            const exitCode = '${{ steps.run-claude.outputs.exit_code }}';
            const timestamp = new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });
            
            // é™åˆ¶è¾“å‡ºé•¿åº¦ï¼Œé¿å…è¯„è®ºè¿‡é•¿
            const maxLength = 60000; // GitHub è¯„è®ºé™åˆ¶çº¦ 65536 å­—ç¬¦
            let truncatedOutput = claudeOutput;
            let wasTruncated = false;
            
            if (claudeOutput.length > maxLength) {
              truncatedOutput = claudeOutput.substring(0, maxLength);
              wasTruncated = true;
            }
            
            const statusIcon = exitCode === '0' ? 'âœ…' : 'âŒ';
            const statusText = exitCode === '0' ? 'æ‰§è¡ŒæˆåŠŸ' : 'æ‰§è¡Œå¤±è´¥';
            
            let body = `## ğŸ¤– Claude Code æ‰§è¡Œç»“æœ\n\n` +
                      `**çŠ¶æ€**: ${statusIcon} ${statusText} (é€€å‡ºç : ${exitCode})\n` +
                      `**æ—¶é—´**: ${timestamp}\n\n` +
                      `### ğŸ“‹ æ‰§è¡Œè¾“å‡º\n\n` +
                      `\`\`\`\n${truncatedOutput}\n\`\`\`\n`;
            
            if (wasTruncated) {
              body += `\n\nâš ï¸ *è¾“å‡ºå†…å®¹è¿‡é•¿ï¼Œå·²æˆªæ–­ã€‚å®Œæ•´æ—¥å¿—è¯·æŸ¥çœ‹ [Actions è¿è¡Œè®°å½•](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})*\n`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: body
            });

      # ==========================================
      # æ­¥éª¤ 9: å¤„ç† Claude äº¤äº’è¯·æ±‚
      # ==========================================
      - name: Handle Claude interaction
        if: steps.run-claude.outputs.interaction_detected == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = ${{ inputs.comment_id }};
            const interactionMessage = `${{ steps.run-claude.outputs.interaction_message }}`;

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: 'ğŸ¤– Claude Code éœ€è¦æ›´å¤šä¿¡æ¯:\n\n```\n' + interactionMessage + '\n```\n\nè¯·åœ¨æ­¤è¯„è®ºä¸‹å›å¤,ç„¶åé‡æ–°è§¦å‘å·¥ä½œæµã€‚'
            });

      # ==========================================
      # æ­¥éª¤ 10: æ£€æŸ¥ Git å˜æ›´
      # ==========================================
      - name: Check for changes
        id: check-changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Detected code changes"
            git status --short
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No code changes detected"
          fi

      # ==========================================
      # æ­¥éª¤ 11: æ¨é€å˜æ›´
      # ==========================================
      - name: Push changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          BRANCH_NAME="issue_${{ inputs.issue_number }}"
          ISSUE_NUMBER="${{ inputs.issue_number }}"

          git add .
          git commit -m "chore: Claude Code automated changes for issue #${ISSUE_NUMBER}" \
                     -m "Co-Authored-By: Claude <noreply@anthropic.com>" || true
          git push origin "$BRANCH_NAME"

          echo "âœ… Changes pushed to branch: $BRANCH_NAME"

      # ==========================================
      # æ­¥éª¤ 12: æ£€æŸ¥ PAT Token é…ç½®å’Œæƒé™
      # ==========================================
      - name: Check PAT Token
        if: steps.check-changes.outputs.has_changes == 'true' && steps.run-claude.outputs.exit_code == '0'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            console.log('ğŸ” Checking PAT Token configuration...');
            
            // æ£€æŸ¥ä½¿ç”¨çš„æ˜¯å“ªä¸ª token
            const usingPAT = '${{ secrets.PAT_TOKEN }}' !== '';
            console.log(`Using PAT_TOKEN: ${usingPAT ? 'âœ… YES' : 'âŒ NO (falling back to GITHUB_TOKEN)'}`);
            
            try {
              // è·å–å½“å‰è®¤è¯ç”¨æˆ·ä¿¡æ¯
              const { data: user } = await github.rest.users.getAuthenticated();
              console.log(`âœ… Authenticated as: ${user.login} (${user.type})`);
              
              // æ£€æŸ¥ä»“åº“æƒé™
              const { data: repo } = await github.rest.repos.get({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              console.log(`âœ… Repository: ${repo.full_name}`);
              console.log(`âœ… Repository permissions:`);
              console.log(`   - admin: ${repo.permissions?.admin || false}`);
              console.log(`   - push: ${repo.permissions?.push || false}`);
              console.log(`   - pull: ${repo.permissions?.pull || false}`);
              
              // å°è¯•åˆ—å‡º PRï¼ˆæµ‹è¯• pull_requests æƒé™ï¼‰
              try {
                const { data: pulls } = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  per_page: 1
                });
                console.log(`âœ… Pull Requests READ permission: OK (found ${pulls.length} open PR)`);
              } catch (error) {
                console.log(`âŒ Pull Requests READ permission: FAILED`);
                console.log(`   Error: ${error.message}`);
              }
              
              // æ£€æŸ¥å“åº”å¤´ä¸­çš„æƒé™ä¿¡æ¯
              const testResponse = await github.request('GET /repos/{owner}/{repo}', {
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              
              if (testResponse.headers['x-accepted-github-permissions']) {
                console.log(`ğŸ“‹ GitHub accepted permissions: ${testResponse.headers['x-accepted-github-permissions']}`);
              }
              
              console.log('\nâœ… Token validation completed');
              
            } catch (error) {
              console.log(`âŒ Token validation failed: ${error.message}`);
              console.log(`   Status: ${error.status}`);
              if (error.response?.headers) {
                console.log(`   Accepted permissions: ${error.response.headers['x-accepted-github-permissions']}`);
              }
              throw error;
            }

      # ==========================================
      # æ­¥éª¤ 13: åˆ›å»º Pull Request
      # ==========================================
      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true' && steps.run-claude.outputs.exit_code == '0'
        id: create-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const branchName = `issue_${{ inputs.issue_number }}`;
            const issueNumber = ${{ inputs.issue_number }};
            const prompt = `${{ inputs.prompt }}`;

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ PR
            const { data: existingPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branchName}`,
              state: 'open'
            });

            let prUrl;
            const timestamp = new Date().toISOString();

            if (existingPRs.length > 0) {
              // PR å·²å­˜åœ¨ï¼Œæ›´æ–° PR æè¿°
              const pr = existingPRs[0];
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                body: 'Closes #' + issueNumber + '\n\n' +
                      '## ğŸ¤– ç”± Claude Code è‡ªåŠ¨ç”Ÿæˆ\n\n' +
                      '**æœ€æ–°è¯·æ±‚**: ' + prompt + '\n' +
                      '**æ›´æ–°æ—¶é—´**: ' + timestamp + '\n\n' +
                      '### ğŸ“‹ å˜æ›´è¯´æ˜\n\n' +
                      'Claude Code å·²æ ¹æ® Issue #' + issueNumber + ' çš„éœ€æ±‚è‡ªåŠ¨ç”Ÿæˆä»£ç å˜æ›´ã€‚\n' +
                      'æ­¤ PR å·²è¢«å¤šæ¬¡æ›´æ–°ï¼Œè¯·æŸ¥çœ‹æœ€æ–°çš„å˜æ›´å†…å®¹ã€‚\n\n' +
                      '### âœ… å®¡æŸ¥æ¸…å•\n\n' +
                      '- [ ] ä»£ç åŠŸèƒ½æ­£ç¡®\n' +
                      '- [ ] æµ‹è¯•é€šè¿‡ï¼ˆå¦‚æœ‰ï¼‰\n' +
                      '- [ ] ä»£ç é£æ ¼ç¬¦åˆè§„èŒƒ\n' +
                      '- [ ] æ–‡æ¡£å·²æ›´æ–°ï¼ˆå¦‚éœ€è¦ï¼‰\n\n' +
                      '---\n\n' +
                      'ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)'
              });

              prUrl = pr.html_url;
              console.log(`âœ… PR already exists and updated: ${prUrl}`);
            } else {
              // åˆ›å»ºæ–° PR
              const { data: pr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'feat: AI-generated solution for #' + issueNumber,
                head: branchName,
                base: 'main',
                body: 'Closes #' + issueNumber + '\n\n' +
                      '## ğŸ¤– ç”± Claude Code è‡ªåŠ¨ç”Ÿæˆ\n\n' +
                      '**åŸå§‹è¯·æ±‚**: ' + prompt + '\n' +
                      '**åˆ›å»ºæ—¶é—´**: ' + timestamp + '\n\n' +
                      '### ğŸ“‹ å˜æ›´è¯´æ˜\n\n' +
                      'Claude Code å·²æ ¹æ® Issue #' + issueNumber + ' çš„éœ€æ±‚è‡ªåŠ¨ç”Ÿæˆä»¥ä¸‹ä»£ç å˜æ›´ã€‚\n\n' +
                      '### âœ… å®¡æŸ¥æ¸…å•\n\n' +
                      '- [ ] ä»£ç åŠŸèƒ½æ­£ç¡®\n' +
                      '- [ ] æµ‹è¯•é€šè¿‡ï¼ˆå¦‚æœ‰ï¼‰\n' +
                      '- [ ] ä»£ç é£æ ¼ç¬¦åˆè§„èŒƒ\n' +
                      '- [ ] æ–‡æ¡£å·²æ›´æ–°ï¼ˆå¦‚éœ€è¦ï¼‰\n\n' +
                      '---\n\n' +
                      'ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)'
              });

              prUrl = pr.html_url;
              console.log(`âœ… Created new PR: ${prUrl}`);
            }

            core.setOutput('pr_url', prUrl);
            return prUrl;

      # ==========================================
      # æ­¥éª¤ 14: æ›´æ–°æˆåŠŸè¯„è®º
      # ==========================================
      - name: Update comment on success
        if: success() && steps.create-pr.outputs.pr_url
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = ${{ inputs.comment_id }};
            const prUrl = '${{ steps.create-pr.outputs.pr_url }}';
            const prompt = `${{ inputs.prompt }}`;

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: 'âœ… **ä»»åŠ¡å®Œæˆ!**\n\n' +
                    'ğŸ“‹ **åŸå§‹è¯·æ±‚**: ' + prompt + '\n\n' +
                    'ğŸ”— **Pull Request**: ' + prUrl + '\n\n' +
                    'è¯·æŸ¥çœ‹ PR å¹¶è¿›è¡Œä»£ç å®¡æŸ¥ã€‚'
            });

      # ==========================================
      # æ­¥éª¤ 15: æ›´æ–°å¤±è´¥è¯„è®º
      # ==========================================
      - name: Update comment on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = ${{ inputs.comment_id }};
            const prompt = `${{ inputs.prompt }}`;
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: 'âŒ **ä»»åŠ¡å¤±è´¥**\n\n' +
                    'ğŸ“‹ **åŸå§‹è¯·æ±‚**: ' + prompt + '\n\n' +
                    'ğŸ” **æŸ¥çœ‹è¯¦ç»†æ—¥å¿—**: [GitHub Actions è¿è¡Œè®°å½•](' + runUrl + ')\n\n' +
                    'è¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯å¹¶é‡è¯•ã€‚'
            });

      # ==========================================
      # æ­¥éª¤ 16: æ›´æ–°æ— å˜æ›´è¯„è®º
      # ==========================================
      - name: Update comment on no changes
        if: success() && steps.check-changes.outputs.has_changes == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = ${{ inputs.comment_id }};
            const prompt = `${{ inputs.prompt }}`;

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: 'âš ï¸ **ä»»åŠ¡å®Œæˆ,ä½†æœªæ£€æµ‹åˆ°ä»£ç å˜æ›´**\n\n' +
                    'ğŸ“‹ **åŸå§‹è¯·æ±‚**: ' + prompt + '\n\n' +
                    'Claude Code æ‰§è¡Œå®Œæˆ,ä½†æœªç”Ÿæˆä»»ä½•ä»£ç å˜æ›´ã€‚è¯·æ£€æŸ¥ä»»åŠ¡æ˜¯å¦éœ€è¦ä»£ç ä¿®æ”¹ã€‚'
            });
