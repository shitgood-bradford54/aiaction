name: CCAI Execute - Reusable Workflow

# å¯å¤ç”¨å·¥ä½œæµ: è¢« ccai-trigger.yml è°ƒç”¨
on:
  workflow_call:
    inputs:
      issue_number:
        description: 'Issue number'
        required: true
        type: string
      prompt:
        description: 'User prompt for Claude Code'
        required: true
        type: string
      comment_id:
        description: 'Initial comment ID for updates'
        required: true
        type: string
    secrets:
      ANTHROPIC_API_KEY:
        description: 'Anthropic API Key for Claude Code'
        required: true
      ANTHROPIC_BASE_URL:
        description: 'Anthropic API Base URL (optional, for third-party proxies)'
        required: false
      PAT_TOKEN:
        description: 'Personal Access Token for Claude Code agent to create PR if needed'
        required: false

jobs:
  execute:
    name: Execute Claude Code
    runs-on: ubuntu-latest
    timeout-minutes: 60

    # å¹¶å‘æ§åˆ¶: æŒ‰ issue ID æ’é˜Ÿ
    concurrency:
      group: ccai-issue-${{ inputs.issue_number }}
      cancel-in-progress: false

    # Service Containers: PostgreSQL + Redis
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: nestjs_ci_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U test_user"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      # ==========================================
      # æ­¥éª¤ 0: æ£€æµ‹æ’é˜ŸçŠ¶æ€å¹¶é€šçŸ¥ç”¨æˆ·
      # ==========================================
      - name: Check if queued and notify
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = ${{ inputs.comment_id }};
            const prompt = `${{ inputs.prompt }}`;
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            // æ£€æŸ¥æ˜¯å¦æœ‰åŒä¸€ issue çš„å…¶ä»–è¿è¡Œä¸­çš„ä»»åŠ¡
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ccai-execute.yml',
              status: 'in_progress'
            });

            // è¿‡æ»¤å‡ºåŒä¸€ issue çš„å…¶ä»–è¿è¡Œ
            const sameIssueRuns = runs.workflow_runs.filter(run =>
              run.id !== context.runId &&
              run.name.includes('issue_${{ inputs.issue_number }}')
            );

            if (sameIssueRuns.length > 0) {
              // æœ‰å…¶ä»–ä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œæ›´æ–°è¯„è®ºä¸º"æ’é˜Ÿä¸­"
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: commentId,
                body: 'ğŸ”„ **æ‚¨çš„è¯·æ±‚å·²åŠ å…¥é˜Ÿåˆ—**\n\n' +
                      'å‰é¢æœ‰ ' + sameIssueRuns.length + ' ä¸ªä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œè¯·ç¨å€™...\n\n' +
                      'ğŸ“ **ä»»åŠ¡**: ' + prompt + '\n' +
                      'ğŸ”— **æŸ¥çœ‹é˜Ÿåˆ—**: [Actions è¿è¡Œæ—¥å¿—](' + runUrl + ')'
              });
            }

      # ==========================================
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      # ==========================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # ==========================================
      # æ­¥éª¤ 2: åˆ†æ”¯ç®¡ç†
      # ==========================================
      - name: Setup branch
        id: setup-branch
        run: |
          bash .github/scripts/ccai/setup-branch.sh "${{ inputs.issue_number }}"

      # ==========================================
      # æ­¥éª¤ 3: å®‰è£… pnpm
      # ==========================================
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8
          run_install: false  # æ‰‹åŠ¨å®‰è£…ä¾èµ–ä»¥ä½¿ç”¨ç¼“å­˜

      # ==========================================
      # æ­¥éª¤ 4: è®¾ç½® Node.js
      # ==========================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ==========================================
      # æ­¥éª¤ 5: å®‰è£…ä¾èµ–
      # ==========================================
      - name: Install dependencies
        run: |
          echo "ğŸ“ Current directory contents:"
          ls -la
          echo "ğŸ” Checking for pnpm-lock.yaml:"
          if [ -f pnpm-lock.yaml ]; then
            echo "âœ… pnpm-lock.yaml found"
            cat pnpm-lock.yaml | head -20
          else
            echo "âŒ pnpm-lock.yaml not found"
            echo "ğŸ“‹ Installing without frozen lockfile"
            pnpm install
          fi

      # ==========================================
      # æ­¥éª¤ 6: åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶
      # ==========================================
      - name: Create environment file
        run: |
          bash .github/scripts/ccai/setup-env.sh "${{ secrets.ANTHROPIC_API_KEY }}" "${{ secrets.ANTHROPIC_BASE_URL }}" "${{ secrets.PAT_TOKEN }}"

      # ==========================================
      # æ­¥éª¤ 7: å®‰è£… Claude Code CLI
      # ==========================================
      - name: Install Claude Code CLI
        run: |
          pnpm add -g @anthropic-ai/claude-code
          claude --version

      # ==========================================
      # æ­¥éª¤ 7.5: åˆå§‹åŒ–æ•°æ®åº“ï¼ˆç”Ÿæˆ Prisma Client + é‡ç½®æ•°æ®åº“ï¼‰
      # ==========================================
      - name: Initialize database
        run: |
          chmod +x scripts/dx
          ./scripts/dx startup -Y --dev
        env:
          NODE_ENV: development        

      # ==========================================
      # æ­¥éª¤ 9: æ‰§è¡Œ Claude Code ä»»åŠ¡
      # ==========================================
      - name: Run Claude Code
        id: run-claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          bash .github/scripts/ccai/run-claude.sh "${{ inputs.prompt }}"

      # ==========================================
      # æ­¥éª¤ 10: è¯»å– Claude è¾“å‡ºå¹¶ä¿å­˜åˆ°å˜é‡ï¼ˆä¸åˆ›å»ºæ–°è¯„è®ºï¼‰
      # ==========================================
      - name: Read Claude output
        if: always() && steps.run-claude.outcome != 'skipped'
        id: read-output
        run: |
          if [ -f claude_output.log ]; then
            # ä½¿ç”¨ base64 ç¼–ç é¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜
            CLAUDE_OUTPUT=$(cat claude_output.log | base64 -w 0 2>/dev/null || cat claude_output.log | base64)
            echo "claude_output_base64=$CLAUDE_OUTPUT" >> $GITHUB_OUTPUT
            echo "has_output=true" >> $GITHUB_OUTPUT
          else
            echo "has_output=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ claude_output.log æ–‡ä»¶ä¸å­˜åœ¨"
          fi

      # ==========================================
      # æ­¥éª¤ 11: å¤„ç† Claude äº¤äº’è¯·æ±‚
      # ==========================================
      - name: Handle Claude interaction
        if: steps.run-claude.outputs.interaction_detected == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = ${{ inputs.comment_id }};
            const interactionMessage = `${{ steps.run-claude.outputs.interaction_message }}`;

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: 'ğŸ¤– Claude Code éœ€è¦æ›´å¤šä¿¡æ¯:\n\n```\n' + interactionMessage + '\n```\n\nè¯·åœ¨æ­¤è¯„è®ºä¸‹å›å¤,ç„¶åé‡æ–°è§¦å‘å·¥ä½œæµã€‚'
            });

      # ==========================================
      # æ­¥éª¤ 12: æ£€æŸ¥ Git å˜æ›´
      # ==========================================
      - name: Check for changes
        id: check-changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Detected code changes"
            git status --short
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No code changes detected"
          fi

      # ==========================================
      # æ­¥éª¤ 13: æäº¤å¹¶æ¨é€å˜æ›´åˆ° issue åˆ†æ”¯
      # ==========================================
      - name: Commit and push changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          BRANCH_NAME="issue_${{ inputs.issue_number }}"
          ISSUE_NUMBER="${{ inputs.issue_number }}"

          git add .
          git commit -m "chore: Claude Code automated changes for issue #${ISSUE_NUMBER}" \
                     -m "Co-Authored-By: Claude <noreply@anthropic.com>" || true
          git push origin "$BRANCH_NAME"

          echo "âœ… Changes committed and pushed to branch: $BRANCH_NAME"

      # ==========================================
      # æ­¥éª¤ 14: æ›´æ–°è¯„è®ºï¼ˆåªæ˜¾ç¤º Claude è¾“å‡ºï¼‰
      # ==========================================
      - name: Update comment with Claude output
        if: always() && steps.read-output.outputs.has_output == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = ${{ inputs.comment_id }};
            const claudeOutputBase64 = '${{ steps.read-output.outputs.claude_output_base64 }}';
            const exitCode = '${{ steps.run-claude.outputs.exit_code }}';
            const timestamp = new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            let body = '';
            
            try {
              const claudeOutput = Buffer.from(claudeOutputBase64, 'base64').toString('utf8');
              const maxLength = 60000; // GitHub è¯„è®ºé™åˆ¶çº¦ 65536 å­—ç¬¦
              let truncatedOutput = claudeOutput;
              let wasTruncated = false;
              
              if (claudeOutput.length > maxLength) {
                truncatedOutput = claudeOutput.substring(0, maxLength);
                wasTruncated = true;
              }
              
              const statusIcon = exitCode === '0' ? 'âœ…' : 'âŒ';
              const statusText = exitCode === '0' ? 'æ‰§è¡ŒæˆåŠŸ' : 'æ‰§è¡Œå¤±è´¥';
              
              body = `## ğŸ¤– Claude Code æ‰§è¡Œç»“æœ\n\n` +
                    `**çŠ¶æ€**: ${statusIcon} ${statusText} (é€€å‡ºç : ${exitCode})\n` +
                    `**æ—¶é—´**: ${timestamp}\n\n` +
                    `\`\`\`\n${truncatedOutput}\n\`\`\`\n`;
              
              if (wasTruncated) {
                body += `\nâš ï¸ *è¾“å‡ºå†…å®¹è¿‡é•¿ï¼Œå·²æˆªæ–­ã€‚å®Œæ•´æ—¥å¿—è¯·æŸ¥çœ‹ [Actions è¿è¡Œè®°å½•](${runUrl})*\n`;
              }
            } catch (error) {
              body = 'âš ï¸ æ— æ³•è§£æ Claude è¾“å‡ºæ—¥å¿—\n';
              console.error('è§£æ Claude è¾“å‡ºå¤±è´¥:', error);
            }

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

